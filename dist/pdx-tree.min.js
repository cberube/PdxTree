var template="<div>Item template. Node name: {{ node.name }}</div>";angular.module("pdxTree",[]).controller("TestTreeCtrl",["$scope","$resource",function($scope,$resource){var NodeSource=$resource("tree-data/:id");$scope.tree={nodeList:null},$scope.tree.nodeList=NodeSource.query({id:"Nodes.json"})}]).directive("testTree",["$compile","pdxTreeDomService",function($compile,pdxTreeDomService){var buildNodes=function(treeElement,scope){var i,templateFunction,nodeElement,nodeScope;if(scope.tree&&scope.tree.nodeList)for(templateFunction=$compile(template),i=0;i<scope.tree.nodeList.length;i++)nodeScope=scope.$new(),nodeScope.node=scope.tree.nodeList[i],nodeElement=templateFunction(nodeScope,function(){}),treeElement.append(nodeElement)};return{replace:!0,restrict:"EA",scope:{tree:"="},controller:function(){},link:function(scope,element){var templateElement;templateElement=pdxTreeDomService.findChildWithAttribute(element,"pdx-tree-item",!0),templateElement=angular.element(templateElement),template=templateElement.html().trim(),scope.$watchCollection("tree.nodeList",function(){buildNodes(element,scope)})}}}]),angular.module("pdxTree").service("pdxTreeNestedImplementation",["$compile","pdxTreeDomService","pdxTreeChildManagerService",function($compile,pdxTreeDomService,pdxTreeChildManagerService){var nestedImplementation={name:"nested",removeChildren:function(itemScope){itemScope.containerElement.html("")},addChildren:function(itemScope,childList){angular.forEach(childList,function(childElement){itemScope.containerElement.append(childElement)})},createItem:function(scope,node){var itemElement,containerElement,childContainerTemplate,childContainerElement,itemTemplate=$compile(scope.itemTemplate),itemScope=scope.$new();return itemElement=itemTemplate(itemScope,function(){}),childContainerElement=pdxTreeDomService.findChildWithAttribute(itemElement,"pdx-tree-children",!0),childContainerTemplate=$compile(scope.childTemplate.clone()),containerElement=childContainerTemplate(itemScope),angular.element(childContainerElement).replaceWith(containerElement),itemScope.node=node,itemScope.itemTemplate=scope.itemTemplate,itemScope.childStrategy=nestedImplementation,itemScope.containerElement=containerElement,itemScope.itemElement=itemElement,itemScope._pdxTreeNodeDepth=scope._pdxTreeNodeDepth+1,itemScope.$watch("node.expanded",angular.bind(itemScope,pdxTreeChildManagerService.renderChildren,itemScope)),itemScope.$watch("node.childList",angular.bind(itemScope,pdxTreeChildManagerService.renderChildren,itemScope)),[itemElement]}};return nestedImplementation}]),angular.module("pdxTree").service("pdxTreeSiblingImplementation",["$compile","pdxTreeChildManagerService",function($compile,pdxTreeChildManagerService){var removeChildren=function(itemScope){angular.forEach(itemScope.childElementList,function(childElement){childElement=angular.element(childElement);var childScope=childElement.scope();childScope&&(removeChildren(childScope),childScope.$destroy()),childElement.remove()}),itemScope.childElementList=[],itemScope.lastChildElement=itemScope.itemElement},siblingImplementation={name:"sibling",removeChildren:removeChildren,addChildren:function(itemScope,childList){angular.forEach(childList,function(childElement){itemScope.lastChildElement.after(childElement),itemScope.lastChildElement=childElement,itemScope.childElementList.push(childElement)})},createItem:function(scope,node){var itemElement,itemTemplate=$compile(scope.itemTemplate),itemScope=scope.$new(),elementList=[];return itemScope.node=node,itemScope.itemTemplate=scope.itemTemplate,itemScope.childElementList=[],itemScope.childStrategy=siblingImplementation,itemScope._pdxTreeNodeDepth=scope._pdxTreeNodeDepth+1,itemElement=itemTemplate(itemScope,function(element,scope){scope.childStrategy=siblingImplementation,scope.lastChildElement=element}),scope.tableMode&&(itemElement=itemElement.find("tr")),elementList.push(itemElement),itemScope.itemElement=itemElement,itemScope.$watch("node.expanded",angular.bind(itemScope,pdxTreeChildManagerService.renderChildren,itemScope)),itemScope.$watch("node.childList",angular.bind(itemScope,pdxTreeChildManagerService.renderChildren,itemScope)),elementList}};return siblingImplementation}]),angular.module("pdxTree").service("pdxTreeChildManagerService",[function(){"use strict";var areChildrenLoading=function(itemList){return itemList===!1?!1:"undefined"!=typeof itemList.$resolved?!itemList.$resolved:!angular.isArray(itemList)},hasChildren=function(node){return node&&node.childList&&angular.isArray(node.childList)&&node.childList.length>0},renderChildren=function(itemScope){var childElementList;return itemScope.childStrategy.removeChildren(itemScope),itemScope.node.expanded&&itemScope.node.childList?itemScope.node.childList.$promise&&!itemScope.node.childList.$resolved?void itemScope.node.childList.$promise.then(angular.bind(this,renderChildren,itemScope)):void angular.forEach(itemScope.node.childList,function(child){childElementList=itemScope.childStrategy.createItem(itemScope,child),itemScope.childStrategy.addChildren(itemScope,childElementList)}):void 0};return{hasChildren:hasChildren,areChildrenLoading:areChildrenLoading,renderChildren:renderChildren}}]),angular.module("pdxTree").service("pdxTreeDomService",[function(){var destroyChildren=function(parentElement){angular.forEach(parentElement.children(),function(element){var scope;element=angular.element(element),scope=element.scope(),scope&&!scope.$$destroyed&&scope.$destroy(),destroyChildren(element),element.remove()})},appendAllElements=function(parentElement,elementList){angular.forEach(elementList,function(element){parentElement.append(element)})},findChildWithAttribute=function(parent,attribute,recursive){var attributeValue,i,children=parent.children(),childrenSearchResult=null;for(i=0;i<children.length;i++){if(attributeValue=children[i].getAttribute(attribute),"undefined"!=typeof attributeValue&&null!==attributeValue)return children[i];if(recursive&&(childrenSearchResult=findChildWithAttribute(angular.element(children[i]),attribute,!0),null!==childrenSearchResult))return childrenSearchResult}return null};return{appendAllElements:appendAllElements,destroyChildren:destroyChildren,findChildWithAttribute:findChildWithAttribute}}]),angular.module("pdxTree").directive("pdxTree",["$rootScope","$compile","pdxTreeChildManagerService","pdxTreeDomService",function($rootScope,$compile,childManagerService,pdxTreeDomService){var toggleChildren=function(){this.node.expanded=!this.node.expanded,this.node.expanded&&null==this.node.childList&&this.loadChildren(this,this.node)},buildTree=function(scope,targetElement){var childElementList=targetElement.children();childElementList&&childElementList.length&&angular.forEach(childElementList,function(childElement){var childScope=angular.element(childElement).scope();childScope&&(childScope.childStrategy.removeChildren(childScope),childScope.$destroy()),childElement.remove()}),scope.pdxTreeController&&angular.forEach(scope.pdxTreeNodeList,function(node){pdxTreeDomService.appendAllElements(targetElement,scope.childStrategy.createItem(scope,node))})};return{restrict:"EA",scope:{pdxTreeNodeList:"=",pdxTreeController:"="},controller:function($scope){$scope.tableMode=!1,$scope.itemContainer=null,this.setItemTemplate=function(itemTemplateElement){$scope.itemTemplate=itemTemplateElement},this.setChildStrategy=function(strategy){$scope.childStrategy=strategy},this.setChildTemplate=function(childTemplate){$scope.childTemplate=childTemplate},this.setTableMode=function(tableMode){$scope.tableMode=tableMode},this.setItemContainer=function(itemContainer){$scope.itemContainer=itemContainer}},link:function(scope){var targetElement=scope.itemContainer.parent();scope._pdxTreeController={toggleChildren:toggleChildren,loadChildren:function(){return!1}},scope._pdxTreeNodeDepth=0,scope.pdxTreeController(scope),scope.toggleChildren=scope.toggleChildren||scope._pdxTreeController.toggleChildren,scope.loadChildren=scope.loadChildren||scope._pdxTreeController.loadChildren,targetElement.html(""),scope.$watchCollection("pdxTreeNodeList",function(){buildTree(scope,targetElement)})}}}]),angular.module("pdxTree").directive("pdxTreeItem",[function(){return{restrict:"EA",require:"?^pdxTree",controller:function($scope){this.getElement=function(){return $scope.element}},link:function(scope,element,attributes,pdxTree){var templateHtml=angular.element(element).clone();scope.element=element,"TBODY"==element[0].tagName&&(templateHtml=angular.element(element).clone(),pdxTree&&pdxTree.setTableMode(!1)),pdxTree&&(pdxTree.setItemTemplate(templateHtml),pdxTree.setItemContainer(element))}}}]),angular.module("pdxTree").directive("pdxTreeChildren",["pdxTreeNestedImplementation","pdxTreeSiblingImplementation",function(pdxTreeNestedImplementation,pdxTreeSiblingImplementation){return{restrict:"EA",require:["?^pdxTree","?^pdxTreeItem"],link:function(scope,element,attributes,treeControllers){var pdxTree=treeControllers[0],pdxTreeItem=treeControllers[1];pdxTree&&pdxTreeItem&&(pdxTree.setChildTemplate(element),pdxTree.setChildStrategy(pdxTreeItem.getElement()===element?pdxTreeSiblingImplementation:pdxTreeNestedImplementation))}}}]);